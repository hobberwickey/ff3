<script>
  var MapPhysics = {
    buildPhysicalMap: function(){
      var props = this.physicalData,
          tiles = this.map_data[0],
          map_size = this.specs.size[0],
          map = this.physical_map;

      if (map_size.x * map_size.y > tiles.length) map_size = this.map_data.specs.size[1];
      
      //if (map_size[0] * map_size[1] < tiles.length) map_size = DIMENSIONS[2];
      
      // var props_tiles = document.getElementById("props");
      // props_tiles.style.width = (32 * map_size.x) + "px";
      for (var i=0; i<tiles.length; i++){
        
        // var p = document.createElement("div");

        // p.className = "prop"
        // p.innerHTML = "<span>" + ((props[tiles[i]][0] & 240) >> 4).toString(2) + "</span><span>" + (props[tiles[i]][0] & 15).toString(2) + "</span><span> " +  ((props[tiles[i]][1] & 240) >> 4).toString(2) + "</span><span>" + (props[tiles[i]][1] & 15).toString(2) + "</span>";
        // props_tiles.appendChild(p);
        
        var x = i & (map_size.x - 1),
            y = ((i / map_size.x) | 0);

        function getTile(x, y){
          if (x >= map_size.x - 1 || x < 1 || y >= map_size.y - 1 || y < 1){ 
            return [0xf7, 0xff, x, y];
          } else {
            var arr = props[tiles[x + (y * map_size.x)]];
                arr.push(x)
                arr.push(y)

            return arr;
          }
        }

        var prop = props[tiles[i]],
            n = getTile(x, y - 1),
            ne = getTile(x + 1, y - 1),
            e = getTile(x + 1, y),
            se = getTile(x + 1, y + 1),
            s = getTile(x, y + 1),
            sw = getTile(x - 1, y + 1),
            w = getTile(x - 1, y),
            nw = getTile(x - 1, y - 1);
        
        //TODO: directions
        function canMove(from, to, direction){
          var results = {};

          //Solid block
          if (to[0] === 0xf7 && to[1] === 0xff ){
            results.layer_0 = false;
            results.layer_1 = false;
            return { layer_0: false, layer_1: false }
          }
         

          if ((from[0] & 0x40) === 0x40 && (to[0] & 0x40) === 0x40){
            if (direction === 2){
              results.stairs = 1;
            } else if (direction === 3){
              results.stairs = 1;
            } else {
              results.stairs = 0;
            }
          } else if ((from[0] & 0x80) === 0x80 && (to[0] & 0x80) === 0x80){
            if (direction === 2){
              results.stairs = 2;
            } else if (direction === 3){
              results.stairs = 2;
            } else {
              results.stairs = 0;
            }
          } else {
            results.stairs = 0
          }

          if (results.stairs === 0){
            //Directional settings
            if (direction === 0 && ((from[1] & 8) !== 8)) {
              return { layer_0: false, layer_1: false }
            }

            if (direction === 1 && ((from[1] & 4) !== 4)) {
              return { layer_0: false, layer_1: false }
            }

            if (direction === 2 && ((from[1] & 1) !== 1)) {
              return { layer_0: false, layer_1: false }
            } 

            if (direction === 3 && ((from[1] & 2) !== 2)) {
              return { layer_0: false, layer_1: false }
            }   
          }  

          if ( (from[0] & 6) === 4 ) {
            results.walk_under = true;
            if ( (to[0] & 6) === 4 ) {
              results.layer_1 = true;
              results.layer_0 = true;
              results.priority = function(s){ return s.priority };
            } else if ( (to[0] & 7) === 1) {
              results.layer_1 = true;
              results.layer_0 = results.stairs === 0 ? false : true;
              results.priority = function(){ return (to[0] & 0x08) >> 3 }//return results.stairs === 0 ? 0 : (to[1] & 0x80) >> 7  };
            } else if ( (to[0] & 7) === 0) {
              results.layer_1 = false;
              results.layer_0 = true
              results.priority = function(){ return 0 };
            } else if ( (to[0] & 7) === 2 ) {
              results.layer_1 = false;
              results.layer_0 = true;
              results.priority = function(){ return 0 };
            } 
            else {
              results.layer_1 = false;
              results.layer_0 = false;
              results.priority = function(){ return 0 };
            }
          } else if ( (from[0] & 6) === 2 ){
            if ( ((to[0] & 7) !== 5) && ((to[0] & 7) !== 7) && (((to[0] & 7) !== 1) || ((from[0] & 1) === 1)) ) {
              if ((to[0] & 7) === 4){
                results.walk_under = true;
              } 

              if ((from[0] & 7) === 3 && (to[0] & 7) !== 4){
                results.layer_0 = true;
                results.layer_1 = true;
                results.priority = function(){ return 0 };
              } else {
                results.layer_0 = true;
                results.layer_1 = false;
                results.priority = function(){ return 0 };
              }
            } else {
              results.layer_0 = false;
              results.layer_1 = false;
              results.priority = function(){ return 0 };
            }
          } else {
            if ( (from[0] & 1) === 0 ){
              if ( ((to[0] & 7) === 0) || ((to[0] & 7) === 4) || ((to[0] & 7) === 3) ){
                results.layer_0 = true;
                results.layer_1 = false;
                results.priority = function(){ return 0 };
              } else {
                results.layer_0 = false;
                results.layer_1 = false;
                results.priority = function(){ return 0 };
              }
            } else {
              if ( (to[0] & 6) === 4){
                results.layer_0 = true;
                results.layer_1 = true;
                results.priority = function(){ return 1 };
              } else if ( (to[0] & 7) === 2 ) {
                results.layer_0 = false;
                results.layer_1 = false;
                results.priority = function(){  return 0 };
              } else if ( (to[0] & 7) === 3 ) {
                results.layer_0 = true;
                results.layer_1 = true;
                results.priority = function(s){  return s.priority };
              } else if ( (to[0] & 6) === 0 ) {
                results.layer_0 = true;
                results.layer_1 = true;
                results.priority = function(){  return 1 };
              } else {
                results.layer_0 = false;
                results.layer_1 = false;
                results.priority = function(s){  return s.priority };
              }
            }
          }

          if ( (from[0] & 0x20) === 0x20 ) results.door = true;

          results.raw = to; 
          return results;    
        }

        if (map[x] === void(0)) map[x] = {};
        
        map[x][y] = {
          mask: prop[0] === 0xf7 && prop[1] === 0xff ? 0 : (prop[0] & 4) >> 2,
          drawPriority: (prop[0] & 12) >> 2,
          stairs: ((prop[0] & 192) >> 6),
          north: canMove(prop, n, 0),
          north_east: canMove(prop, ne, 2),
          east: canMove(prop, e, 2),
          south_east: canMove(prop, se, 2),
          south: canMove(prop, s, 1),
          south_west: canMove(prop, sw, 3),
          west: canMove(prop, w, 3),
          north_west: canMove(prop, nw, 3)
        }
      }
    },

    getPhysicalTile: function(x, y){

    },

    canMoveLeft: function(sprite){
      var x = sprite.coords.x,
          y = sprite.coords.y,
          current = this.getPhysicalTile(x, y),
          next = this.getPhysicalTile(x - 1, y);

      return true
    },

    canMoveRight: function(sprite){
      return true
    },

    canMoveUp: function(sprite){
      return true
    },

    canMoveDown: function(sprite){
      return true
    }
  }
</script>